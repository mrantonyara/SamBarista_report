<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SamBarista — Dashboard</title>

  <!-- Tailwind Play CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / ReactDOM UMD (prod can be used instead) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Recharts UMD -->
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-gray-800">
  <div id="root" class="p-4 md:p-8"></div>

  <!-- App (JSX via Babel) -->
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    const {
      BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell,
      PieChart, Pie
    } = Recharts;

    const baseProductsTemplate = [
      { name: 'Choco-Pie', qty: 0, price: 250, purchase: 130, coffee: 0, milk: 0, chocolate: 0, coconut: 0, water: 0, stick: 0, straw: 0, cup: 0, sleeve: 0, lid: 0, sugar: 0 },
      { name: 'Choco-Pie Dark', qty: 0, price: 250, purchase: 130, coffee: 0, milk: 0, chocolate: 0, coconut: 0, water: 0, stick: 0, straw: 0, cup: 0, sleeve: 0, lid: 0, sugar: 0 },
      { name: 'Picnic', qty: 0, price: 450, purchase: 314, coffee: 0, milk: 0, chocolate: 0, coconut: 0, water: 0, stick: 0, straw: 0, cup: 0, sleeve: 0, lid: 0, sugar: 0 },
      { name: 'Twix', qty: 0, price: 550, purchase: 365, coffee: 0, milk: 0, chocolate: 0, coconut: 0, water: 0, stick: 0, straw: 0, cup: 0, sleeve: 0, lid: 0, sugar: 0 },
      { name: 'Американо 250ml (SamBarista)', qty: 0, price: 490, purchase: 0, coffee: 150, milk: 0, chocolate: 0, coconut: 0, water: 8, stick: 0, straw: 0, cup: 0, sleeve: 0, lid: 0, sugar: 0 },
      { name: 'Горячий шоколад 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 0, milk: 0, chocolate: 200, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Горячий шоколад 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 0, milk: 0, chocolate: 250, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Какао 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 0, milk: 120, chocolate: 100, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Какао 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 0, milk: 150, chocolate: 120, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Капучино 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 100, milk: 120, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Капучино 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 120, milk: 150, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Кокосовый коктейль 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 0, milk: 120, chocolate: 0, coconut: 100, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Кокосовый коктейль 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 0, milk: 150, chocolate: 0, coconut: 120, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Кокосовый раф 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 100, milk: 120, chocolate: 0, coconut: 100, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Кокосовый раф 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 120, milk: 150, chocolate: 0, coconut: 120, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Кокосовый шоколад 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 0, milk: 0, chocolate: 120, coconut: 100, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Кокосовый шоколад 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 0, milk: 0, chocolate: 150, coconut: 120, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Латте 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 120, milk: 150, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Латте 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 150, milk: 180, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Моккачино 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 100, milk: 100, chocolate: 100, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Моккачино 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 120, milk: 120, chocolate: 120, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Таёжный чай 350ml (SamBarista)', qty: 0, price: 500, purchase: 190, coffee: 0, milk: 0, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Флэт Уайт 250ml (SamBarista)', qty: 0, price: 590, purchase: 0, coffee: 100, milk: 150, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 },
      { name: 'Флэт Уайт 350ml (SamBarista)', qty: 0, price: 690, purchase: 0, coffee: 120, milk: 180, chocolate: 0, coconut: 0, water: 8, stick: 5, straw: 8, cup: 25, sleeve: 12, lid: 20, sugar: 30 }
    ];

    const defaultColors = ['#f59e0b', '#8b5cf6', '#3b82f6', '#10b981', '#ef4444', '#ec4899'];

    function escapeRegex(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function encodeForUrl(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }
    function decodeFromUrl(b64) {
      try {
        return decodeURIComponent(escape(atob(b64)));
      } catch (e) {
        return null;
      }
    }

    function App(){
      const [products, setProducts] = useState(JSON.parse(JSON.stringify(baseProductsTemplate)));
      const [search, setSearch] = useState('');
      const [expanded, setExpanded] = useState(null);
      const [templateInput, setTemplateInput] = useState('');
      const [shareUrl, setShareUrl] = useState('');

      useEffect(() => {
        // если в URL есть data=... — декодируем и импортируем
        const params = new URLSearchParams(window.location.search);
        const data = params.get('data');
        if (data) {
          const decoded = decodeFromUrl(data);
          if (decoded) {
            setTemplateInput(decoded);
            setTimeout(() => importFromTemplate(decoded), 50);
          }
        }
      }, []);

      const updateQty = (i, val) => {
        const copy = products.map(p => ({...p}));
        copy[i].qty = Math.max(0, parseInt(val) || 0);
        setProducts(copy);
      };

      const calculations = useMemo(() => {
        let totalRevenue=0, totalCost=0, totalAcq=0, totalTax=0, totalOFD=0, totalProfit=0, totalItems=0;
        let totals = { coffee:0, milk:0, chocolate:0, coconut:0, water:0, stick:0, straw:0, cup:0, sleeve:0, lid:0, sugar:0, purchase:0 };
        products.forEach(p=>{
          const revenue = p.price * p.qty;
          const cost = (p.purchase + p.coffee + p.milk + p.chocolate + p.coconut + p.water + p.stick + p.straw + p.cup + p.sleeve + p.lid + p.sugar) * p.qty;
          const acquiring = revenue * 0.03;
          const tax = revenue * 0.03;
          const ofd = p.qty * 19.63;
          const profit = revenue - cost - acquiring - tax - ofd;
          totalRevenue += revenue;
          totalCost += cost;
          totalAcq += acquiring;
          totalTax += tax;
          totalOFD += ofd;
          totalProfit += profit;
          totalItems += p.qty;
          totals.coffee += p.coffee * p.qty;
          totals.milk += p.milk * p.qty;
          totals.chocolate += p.chocolate * p.qty;
          totals.coconut += p.coconut * p.qty;
          totals.water += p.water * p.qty;
          totals.stick += p.stick * p.qty;
          totals.straw += p.straw * p.qty;
          totals.cup += p.cup * p.qty;
          totals.sleeve += p.sleeve * p.qty;
          totals.lid += p.lid * p.qty;
          totals.sugar += p.sugar * p.qty;
          totals.purchase += p.purchase * p.qty;
        });
        const margin = totalRevenue>0 ? (totalProfit/totalRevenue*100) : 0;
        return { totalRevenue, totalCost, totalAcq, totalTax, totalOFD, totalProfit, totalItems, margin, totals };
      }, [products]);

      const topProducts = useMemo(()=>{
        return products.map(p=>{
          const revenue = p.price * p.qty;
          const cost = (p.purchase + p.coffee + p.milk + p.chocolate + p.coconut + p.water + p.stick + p.straw + p.cup + p.sleeve + p.lid + p.sugar) * p.qty;
          const profit = revenue - cost - (revenue*0.06) - (p.qty*19.63);
          return { name: p.name, profit };
        }).sort((a,b)=>b.profit - a.profit).slice(0,5);
      }, [products]);

      const expenseBreakdown = useMemo(()=>{
        const t = calculations.totals;
        const arr = [
          { name: 'Кофе', value: t.coffee },
          { name: 'Молоко', value: t.milk },
          { name: 'Шоколад', value: t.chocolate },
          { name: 'Кокос', value: t.coconut },
          { name: 'Упаковка', value: t.cup + t.lid + t.sleeve },
          { name: 'Закупка', value: t.purchase }
        ];
        return arr.filter(x=>x.value>0);
      }, [calculations]);

      // импорт из строки-шаблона в формате, как дал пользователь:
      // имя товара + {qty}{totalRevenue} подряд, без разделителей.
      // алгоритм: ищем в строке по полному названию товара (больше длины — раньше), затем читаем последовательность цифр сразу после имени.
      // из цифр пытаемся выделить префикс (qty) и суффикс (revenue) таким, чтобы revenue == qty * price.
      function importFromTemplate(input) {
        if (!input) return;
        const s = input.trim();
        if (!s) return;
        // работаем с копией продуктов
        const copy = products.map(p=>({ ...p, qty:0 }));
        // сортируем имена по длине — чтобы найти более длинные имена раньше (избежать частичных совпадений)
        const names = copy.map(p=>p.name).sort((a,b)=>b.length - a.length);
        // для удобства — оригинальная строк, будем перемещать маркеры, но проще — для каждого имени ищем все вхождения
        names.forEach(name => {
          const regex = new RegExp(escapeRegex(name) + '(\\d+)', 'g');
          let match;
          while ((match = regex.exec(s)) !== null) {
            const digits = match[1]; // например "51250"
            const prodIndex = copy.findIndex(p => p.name === name);
            if (prodIndex === -1) continue;
            const prod = copy[prodIndex];
            let found = false;
            // пробуем разделить digits на префикс (qty) и суффикс (revenue)
            for (let prefixLen=1; prefixLen<=Math.min(4, digits.length-1); prefixLen++){
              const qtyStr = digits.slice(0, prefixLen);
              const revStr = digits.slice(prefixLen);
              const qty = parseInt(qtyStr,10);
              const rev = parseInt(revStr,10);
              if (!isNaN(qty) && !isNaN(rev) && prod.price>0 && rev === qty * prod.price) {
                copy[prodIndex].qty = qty;
                found = true;
                break;
              }
            }
            if (!found) {
              // fallback: если невозможно, попробуем найти qty как первая цифра и revenue как остаток (на всякий случай)
              const qtyGuess = parseInt(digits.slice(0,1),10);
              if (!isNaN(qtyGuess)) {
                // если цена известна — можно попытаться вычислить qty = round(rev/price) — но без ошибок не будем менять
                // в fallback просто поставим qtyGuess
                copy[prodIndex].qty = qtyGuess;
              }
            }
          }
        });
        setProducts(copy);
      }

      function handleImportClick(){
        importFromTemplate(templateInput);
      }

      function handleGenerateLink(){
        // кодируем исходную шаблонную строку — это позволит восстанавливать данные точно
        const b64 = encodeForUrl(templateInput);
        const url = `${location.origin}${location.pathname}?data=${b64}`;
        setShareUrl(url);
        // копировать в буфер — удобно
        try {
          navigator.clipboard.writeText(url);
        } catch (e) {}
      }

      function resetAll(){
        setProducts(JSON.parse(JSON.stringify(baseProductsTemplate)));
        setTemplateInput('');
        setShareUrl('');
        const u = new URL(location);
        u.searchParams.delete('data');
        window.history.replaceState({}, '', u.toString());
      }

      // filtered view
      const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

      return (
        <div className="max-w-7xl mx-auto">
          <header className="mb-6">
            <div className="flex items-center gap-3 mb-2">
              <svg width="44" height="44" viewBox="0 0 24 24" fill="none" className="text-amber-500">
                <path d="M8 7h8v3a4 4 0 0 1-8 0V7z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                <rect x="3" y="10" width="18" height="8" rx="2" stroke="currentColor" strokeWidth="1.5"/>
              </svg>
              <div>
                <h1 className="text-3xl font-bold">SamBarista</h1>
                <div className="text-sm text-gray-600">Учёт продаж — импорт по шаблону и генерация ссылки</div>
              </div>
            </div>
          </header>

          {/* Controls */}
          <div className="grid md:grid-cols-2 gap-4 mb-6">
            <div className="bg-white rounded-2xl p-4 shadow border">
              <h3 className="font-semibold mb-2">Вставьте вашу строку (формат: имя + qty+revenue подряд)</h3>
              <textarea
                value={templateInput}
                onChange={e=>setTemplateInput(e.target.value)}
                rows="4"
                placeholder="Вставьте, например: Choco-Pie51250Choco-Pie Dark3750..."
                className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
              />
              <div className="flex gap-2 mt-3">
                <button onClick={handleImportClick} className="px-4 py-2 bg-amber-500 text-white rounded-lg shadow">Импортировать</button>
                <button onClick={handleGenerateLink} className="px-4 py-2 bg-sky-600 text-white rounded-lg shadow">Сгенерировать ссылку</button>
                <button onClick={resetAll} className="px-4 py-2 bg-gray-200 rounded-lg">Сбросить</button>
              </div>
              {shareUrl && (
                <div className="mt-3 text-sm text-gray-700">
                  <div className="break-words">Ссылка с вашими данными (скопирована в буфер, если браузер разрешил):</div>
                  <div className="mt-1 p-2 bg-gray-50 border rounded text-xs break-words">{shareUrl}</div>
                </div>
              )}
            </div>

            <div className="bg-white rounded-2xl p-4 shadow border">
              <h3 className="font-semibold mb-2">Краткая статистика</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-slate-50 rounded">
                  <div className="text-xs text-gray-600">Выручка</div>
                  <div className="text-lg font-bold">{Math.round(calculations.totalRevenue).toLocaleString()} ₸</div>
                </div>
                <div className="p-3 bg-slate-50 rounded">
                  <div className="text-xs text-gray-600">Затраты</div>
                  <div className="text-lg font-bold">{Math.round(calculations.totalCost).toLocaleString()} ₸</div>
                </div>
                <div className="p-3 bg-slate-50 rounded">
                  <div className="text-xs text-gray-600">Прибыль</div>
                  <div className="text-lg font-bold">{Math.round(calculations.totalProfit).toLocaleString()} ₸</div>
                </div>
                <div className="p-3 bg-slate-50 rounded">
                  <div className="text-xs text-gray-600">Продано шт.</div>
                  <div className="text-lg font-bold">{calculations.totalItems}</div>
                </div>
                <div className="p-3 bg-slate-50 rounded">
                  <div className="text-xs text-gray-600">Маржа</div>
                  <div className="text-lg font-bold">{calculations.margin.toFixed(1)}%</div>
                </div>
                <div className="p-3 bg-slate-50 rounded">
                  <div className="text-xs text-gray-600">Налоги+эквайринг+OFD</div>
                  <div className="text-lg font-bold">{Math.round(calculations.totalTax + calculations.totalAcq + calculations.totalOFD).toLocaleString()} ₸</div>
                </div>
              </div>
              <div className="text-xs text-gray-500 mt-3">Автообновлено: {new Date().toLocaleString('ru-RU')}</div>
            </div>
          </div>

          {/* Charts */}
          <div className="grid lg:grid-cols-2 gap-6 mb-6">
            <div className="bg-white rounded-2xl p-4 shadow border">
              <h3 className="font-semibold mb-3">Топ-5 по прибыли</h3>
              <div style={{width:'100%', height:260}}>
                <ResponsiveContainer>
                  <BarChart layout="vertical" data={topProducts}>
                    <XAxis type="number" stroke="#9ca3af" />
                    <YAxis dataKey="name" type="category" width={150} stroke="#9ca3af" />
                    <Tooltip formatter={(v)=>`${Math.round(v).toLocaleString()} ₸`} />
                    <Bar dataKey="profit" radius={[0,8,8,0]}>
                      {topProducts.map((entry, idx) => <Cell key={idx} fill={defaultColors[idx % defaultColors.length]} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="bg-white rounded-2xl p-4 shadow border">
              <h3 className="font-semibold mb-3">Структура расходов</h3>
              <div style={{width:'100%', height:260}}>
                <ResponsiveContainer>
                  <PieChart>
                    <Pie data={expenseBreakdown} dataKey="value" cx="50%" cy="50%" outerRadius={80} label={(entry) => `${entry.name}`} >
                      {expenseBreakdown.map((e, i) => <Cell key={i} fill={defaultColors[i % defaultColors.length]} />)}
                    </Pie>
                    <Tooltip formatter={(v)=>`${Math.round(v).toLocaleString()} ₸`} />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>

          {/* Products table */}
          <div className="bg-white rounded-2xl p-4 shadow border overflow-x-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-semibold">Редактор продаж</h3>
              <input
                value={search}
                onChange={e=>setSearch(e.target.value)}
                placeholder="Поиск товара..."
                className="px-3 py-2 border rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-amber-500"
              />
            </div>

            <table className="w-full">
              <thead>
                <tr className="text-xs text-gray-600">
                  <th className="text-left p-3">Продукт</th>
                  <th className="p-3 text-center">Кол-во</th>
                  <th className="p-3 text-right">Цена</th>
                  <th className="p-3 text-right">Выручка</th>
                  <th className="p-3 text-right">Прибыль</th>
                  <th className="p-3"></th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((p, i) => {
                  const idx = products.findIndex(x=>x.name===p.name);
                  const revenue = p.price * p.qty;
                  const cost = (p.purchase + p.coffee + p.milk + p.chocolate + p.coconut + p.water + p.stick + p.straw + p.cup + p.sleeve + p.lid + p.sugar) * p.qty;
                  const acq = revenue * 0.03;
                  const tax = revenue * 0.03;
                  const ofd = p.qty * 19.63;
                  const profit = revenue - cost - acq - tax - ofd;
                  const isExp = expanded === idx;
                  return (
                    <React.Fragment key={idx}>
                      <tr className="hover:bg-gray-50">
                        <td className="p-3">{p.name}</td>
                        <td className="p-3 text-center">
                          <input type="number" min="0" value={p.qty} onChange={(e)=>updateQty(idx, e.target.value)}
                            className="w-20 px-2 py-1 border rounded text-center" />
                        </td>
                        <td className="p-3 text-right">{p.price} ₸</td>
                        <td className="p-3 text-right text-green-600 font-semibold">{Math.round(revenue).toLocaleString()} ₸</td>
                        <td className="p-3 text-right text-purple-600 font-semibold">{Math.round(profit).toLocaleString()} ₸</td>
                        <td className="p-3 text-center">
                          <button onClick={()=>setExpanded(isExp?null:idx)} className="text-sm text-sky-600">
                            {isExp ? 'Свернуть' : 'Подробнее'}
                          </button>
                        </td>
                      </tr>
                      {isExp && (
                        <tr>
                          <td colSpan="6" className="bg-gray-50 p-3">
                            <div className="grid md:grid-cols-3 gap-3 text-sm">
                              <div>Закупка: <b>{(p.purchase * p.qty).toLocaleString()} ₸</b></div>
                              <div>Кофе: <b>{(p.coffee * p.qty).toLocaleString()} ₸</b></div>
                              <div>Молоко: <b>{(p.milk * p.qty).toLocaleString()} ₸</b></div>
                              <div>Шоколад: <b>{(p.chocolate * p.qty).toLocaleString()} ₸</b></div>
                              <div>Кокос: <b>{(p.coconut * p.qty).toLocaleString()} ₸</b></div>
                              <div>Стакан: <b>{(p.cup * p.qty).toLocaleString()} ₸</b></div>
                              <div>Эквайринг: <b className="text-red-600">{Math.round(acq).toLocaleString()} ₸</b></div>
                              <div>Налог: <b className="text-red-600">{Math.round(tax).toLocaleString()} ₸</b></div>
                              <div>OFD: <b>{Math.round(ofd).toLocaleString()} ₸</b></div>
                            </div>
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>

          <footer className="text-center text-sm text-gray-500 mt-6">
            <div>SamBarista Dashboard • Готово для публикации на GitHub Pages</div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
